---
- name: Install Docker and Configure Docker Swarm
  hosts: docker_servers
  become: yes
  tasks:

    - name: Install packages required for Docker
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: Install Docker Engine (official script)
      shell: curl -fsSL https://get.docker.com | bash

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

# ----------------------------------------------------------------------
# SWARM MASTER
# ----------------------------------------------------------------------

- name: Enable Docker Swarm on Master
  hosts: docker_master
  become: yes
  tasks:

    - name: Initialize Swarm (ignore if already done)
      shell: docker swarm init --advertise-addr {{ ansible_default_ipv4.address }}
      ignore_errors: yes

    - name: Get worker token
      shell: docker swarm join-token -q worker
      register: worker_token

    - name: Get manager token
      shell: docker swarm join-token -q manager
